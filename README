# Family Photo Organizer (YOLOv8)

Local-first family photo classifier with:
- Local model training (`train/family` -> `db/family_db.pkl`)
- Cloud-style model training in UI (multiple named models)
- Web UI + Electron desktop app + DMG packaging

---

## 1) What This App Does

Given a folder of photos, it classifies each image into:
- `family`
- `non_family`

Detection pipeline:
1. Detect faces with YOLOv8-face
2. Match detected faces to trained face embeddings
3. Mark image as family if at least one face is recognized (default behavior)

---

## 2) Main Modes

### Local mode
- Uses local DB (`db/family_db.pkl`) and local face crops (`trained_faces/`)
- Optional Edge model support

### Cloud mode (default in UI)
- You can train multiple named models under `cloud_models/`
- You can:
  - Train a brand-new model
  - Continue training an existing model with new photos

---

## 3) Project Structure

```text
family_photo_organizer/
├── app_yolo.py                       # Web app (Flask + UI)
├── family_photo_detector_yolo.py     # Training/classification core + CLI
├── train/
│   └── family/                       # Local training photos
├── db/                               # Local DB output
├── trained_faces/                    # Local face crops output
├── cloud_models/                     # Cloud-mode named models
├── results/                          # Downloadable result zip files
├── runtime/uploads/                  # Temporary run/extract folders (auto-clean)
├── electron/main.js                  # Desktop shell
├── scripts/build_dmg.sh              # DMG build helper
└── package.json                      # Electron build scripts
```

---

## 4) Requirements

- Python 3.10+ (3.11 recommended)
- macOS/Linux for web mode
- macOS + Node.js/npm for desktop DMG build

Install Python deps (inside venv):

```bash
cd /Users/kevinvo/Documents/family_photo_organizer
python3 -m venv env
source env/bin/activate
pip install --upgrade pip
pip install flask numpy opencv-python face_recognition scikit-learn ultralytics
```

Notes:
- `face_recognition` depends on `dlib`.
- If `yolov8n-face.pt` is missing, the app can auto-download it (network required).

---

## 5) Run Web App

```bash
cd /Users/kevinvo/Documents/family_photo_organizer
source env/bin/activate
python app_yolo.py
```

Open:
- `http://127.0.0.1:5050`

Optional env vars:
- `APP_HOST` (default `127.0.0.1`)
- `APP_PORT` (default `5050`)
- `FPO_APP_DATA_DIR` (default project root when running directly)
- `PROCESS_WORKERS` (default `4`)

---

## 6) Local Training (CLI)

Put family photos in:
- `train/family/`

Train:

```bash
cd /Users/kevinvo/Documents/family_photo_organizer
source env/bin/activate
python family_photo_detector_yolo.py train
```

Outputs:
- `db/family_db.pkl`
- `trained_faces/`

Optional edge model:

```bash
python family_photo_detector_yolo.py train-edge
```

Check one image:

```bash
python family_photo_detector_yolo.py check --image /absolute/path/to/photo.jpg
```

Batch organize a folder:

```bash
python family_photo_detector_yolo.py batch --folder /absolute/path/to/photos
```

---

## 7) Cloud Training in UI

Cloud mode is default in the web/desktop UI.

### Train new model
1. In `Cloud Model Training`, leave `Train as new model`
2. Enter `Model name`
3. `Browse Train Folder...`
4. Set `Number of persons`
5. Click `Extract Faces`
6. Drag/drop faces between people or `Not a Face`
7. Click `Train Model`

### Continue training existing model
1. In `Cloud Model Training`, choose `Continue: <existing_model>`
2. Choose one of:
   - Leave `Model name` empty -> update same model
   - Enter new `Model name` -> create a new model based on old + new faces
3. Browse new training folder
4. Extract faces, adjust assignments, then train

How continue works:
- Existing model faces are loaded
- New extracted faces are merged
- DB is rebuilt with combined data

---

## 8) Detection in UI

Section: `Use Trained Model to Detect Family Photos`

Options:
- `YOLO Conf` slider
- `Similarity` slider
- Local mode: optional `Use Edge Model`
- Cloud mode: choose trained cloud model

Flow:
1. Browse folder
2. Run
3. Download ZIP from link shown when done

Side panel:
- Shows per-image decision steps
- Shows detected face comparisons (train thumbnail vs query face thumbnail)

---

## 9) Cleanup and Storage

### Reset button
`Reset + Cleanup` in Cloud section will remove:
- All `cloud_models/`
- Runtime temp folders
- Extract sessions
- Saved `results_*.zip`

### Automatic cleanup
The backend also auto-cleans:
- Finished runtime jobs after TTL
- Old result zips by age/count limits
- Legacy temp folders from old versions in `/tmp`

Related env vars:
- `RUN_CACHE_TTL_S` (default `300`)
- `RESULTS_RETENTION_S` (default `604800` = 7 days)
- `RESULTS_KEEP_MAX` (default `40`)

---

## 10) Desktop App (Electron)

### Run desktop in dev

```bash
cd /Users/kevinvo/Documents/family_photo_organizer
npm install
npm run electron:dev
```

### Build DMG

One command:

```bash
cd /Users/kevinvo/Documents/family_photo_organizer
bash ./scripts/build_dmg.sh
```

Or manual:

```bash
npm run build:dmg
```

Output:
- `release/FamilyPhotoOrganizer-<version>-<arch>.dmg`

### Install
1. Open DMG
2. Drag app to `/Applications`
3. Launch from `/Applications`

First launch can take ~30-60s while models load. Desktop now shows loading screen during startup.

---

## 11) Troubleshooting

### `ERR_CONNECTION_REFUSED` at startup
- Usually backend is still loading or app instance is stale.
- Use latest DMG and run from `/Applications`.
- Check startup log:
  - `~/Library/Application Support/Family Photo Organizer/startup.log`

### White page
- Quit all old app instances
- Reinstall latest DMG
- Relaunch from `/Applications`

### Build fails at PyInstaller cache permission
- Run build outside restricted sandbox (normal terminal)
- Re-run:
  - `npm run build:dmg`

---

## 12) Legacy Temp Cleanup Script

If you need manual cleanup for older temp layouts:

```bash
cd /Users/kevinvo/Documents/family_photo_organizer
./clean_up.sh --dry-run
./clean_up.sh --yes
```

---

## 13) License

MIT

